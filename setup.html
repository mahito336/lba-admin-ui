<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>LBA 環境構築</title>

<script>
// -------------------------------
//  OAuth 設定
// -------------------------------
const CLIENT_ID =
  "990347544512-tu7i4t6cg65t4ihdtkbqo00gobtuvas0.apps.googleusercontent.com";

const SCOPES = [
  "openid",
  "https://www.googleapis.com/auth/userinfo.email",
  "https://www.googleapis.com/auth/userinfo.profile",
  "https://www.googleapis.com/auth/drive.file",
  "https://www.googleapis.com/auth/script.projects",
  "https://www.googleapis.com/auth/script.deployments",
].join(" ");

let ACCESS_TOKEN = null;
let USER_EMAIL = null;
let COPIED_FILE_ID = null;

// -------------------------------
// Google OAuth → トークン取得
// -------------------------------
async function authenticate() {
  const url =
    "https://accounts.google.com/o/oauth2/v2/auth?" +
    new URLSearchParams({
      client_id: CLIENT_ID,
      redirect_uri: window.location.origin + window.location.pathname,
      response_type: "token",
      scope: SCOPES,
      include_granted_scopes: "true",
      prompt: "consent",
    });

  window.location.href = url;
}

// -------------------------------
// ページ読み込み時 → URLからアクセストークン取得
// -------------------------------
window.onload = async () => {
  if (window.location.hash.includes("access_token")) {
    const params = new URLSearchParams(window.location.hash.substring(1));
    ACCESS_TOKEN = params.get("access_token");

    document.getElementById("step-auth").style.display = "none";
    document.getElementById("step-info").style.display = "block";

    await fetchUserInfo();
  }
};

// -------------------------------
// ユーザー情報取得
// -------------------------------
async function fetchUserInfo() {
  const res = await fetch("https://www.googleapis.com/oauth2/v2/userinfo", {
    headers: { Authorization: "Bearer " + ACCESS_TOKEN },
  });
  const data = await res.json();

  USER_EMAIL = data.email;
  document.getElementById("user-email").textContent = USER_EMAIL;
}

// -------------------------------
// STEP2: テンプレートを講師Driveにコピー
// -------------------------------
async function copyTemplate() {
  const templateFileId = "1Ff8cgHw_Y9rbjue0sIO8xIWwmMY5rPHAUWoFigXW6nE"; // テンプレID固定
  const copyName = "LBA_TEACHER_SPREADSHEET";

  const res = await fetch(
    `https://www.googleapis.com/drive/v3/files/${templateFileId}/copy`,
    {
      method: "POST",
      headers: {
        Authorization: "Bearer " + ACCESS_TOKEN,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ name: copyName }),
    }
  );

  const data = await res.json();
  COPIED_FILE_ID = data.id;

  document.getElementById("copied-file-id").textContent = COPIED_FILE_ID;
  document.getElementById("step-copy").style.display = "none";
  document.getElementById("step-script").style.display = "block";
}
</script>

<style>
body { font-family: system-ui; margin: 20px; }
.step { padding: 16px; margin-bottom: 20px; background: #f0f7ff; border-radius: 10px; }
</style>

</head>
<body>

<h2>LBA 環境構築（正式版）</h2>

<!-- STEP 1: OAuth -->
<div class="step" id="step-auth">
  <h3>STEP1：Googleアカウントにログイン</h3>
  <button onclick="authenticate()">Googleアカウントを選択する</button>
</div>

<!-- STEP 2: User Info -->
<div class="step" id="step-info" style="display:none">
  <h3>STEP2：ログイン確認</h3>
  <p>ログイン中のアカウント：</p>
  <p style="font-weight:bold" id="user-email">確認中...</p>
  <button onclick="document.getElementById('step-copy').style.display='block'">
    次へ進む
  </button>
</div>

<!-- STEP 3: Copy Template -->
<div class="step" id="step-copy" style="display:none">
  <h3>STEP3：LBA テンプレートをコピーする</h3>
  <button onclick="copyTemplate()">スプレッドシートをコピー</button>
  <p>コピーされた FileID：<span id="copied-file-id">未コピー</span></p>
</div>

<!-- STEP 4: GAS（後で作成） -->
<div class="step" id="step-script" style="display:none">
  <h3>STEP4：GAS プロジェクトを構築する</h3>
  <p>※まだ実装中：次回 GAS 自動生成を追加します。</p>
</div>

</body>
</html>
