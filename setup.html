<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>LBA 環境構築</title>

<!-- ブランドカラー -->
<style>
  :root {
    --brand: #1A73E8; /* Mahito Blue */
    --bg: #f8fafc;
  }
  body {
    margin:0; padding:20px; background:var(--bg);
    font-family: system-ui, sans-serif;
  }
  .container {
    max-width:480px; margin:0 auto; background:white;
    padding:24px; border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
  }
  h2 {
    margin:0 0 16px; font-size:22px; color:#111;
  }
  .step {
    margin-bottom:24px;
  }
  .btn {
    padding:12px 18px; width:100%;
    background:var(--brand); color:white;
    border:none; border-radius:8px; font-size:16px;
    cursor:pointer;
  }
  .btn:disabled {
    background:#b7c7e1; cursor:not-allowed;
  }
  .small {
    font-size:13px; color:#555;
  }
  .info-box {
    background:#eef5ff; padding:10px;
    border-radius:8px; margin-top:8px;
    font-size:14px; color:#333;
  }
  #result {
    white-space:pre-wrap;
    background:#eee; padding:12px;
    border-radius:8px;
    margin-top:16px;
    font-size:13px;
  }
  #tenantId {
    width:100%; padding:10px; margin:8px 0 0;
    border:1px solid #ddd; border-radius:6px;
    font-size:15px;
  }
</style>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>

<div class="container">

  <h2>LBA 環境構築</h2>

  <!-- Step 1 -->
  <div class="step">
    <b>STEP1：Google アカウントを選択</b>
    <div class="small">このアカウントの Drive 上に LBA 環境（スプレッドシート等）が作成されます。</div>

    <div id="g_id_onload"
         data-client_id="745988638249-a91qhekn7c15b3oifaolqnc0fmrghi8p.apps.googleusercontent.com"
         data-context="signup"
         data-ux_mode="popup"
         data-auto_select="false"
         data-callback="onCredentialResponse"
         data-itp_support="true">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="signin_with"
         data-size="large"
         data-logo_alignment="left">
    </div>

    <div id="selectedAccount" class="info-box" style="display:none;"></div>
  </div>

  <!-- Step 2 -->
  <div class="step">
    <b>STEP2：テナントIDの確認</b>
    <div class="small">契約時に発行されたテナントIDが自動入力されます。</div>
    <input id="tenantId" readonly />
  </div>

  <!-- Step 3 -->
  <div class="step">
    <b>STEP3：環境を構築</b>
    <div class="small">以下のボタンを押すと、スプレッドシートが自動作成され、講師用 / 生徒用ポータルが有効になります。</div>
    <button id="btnProvision" class="btn" disabled onclick="runProvision()">環境を構築する</button>
  </div>

  <pre id="result"></pre>

</div>

<script>
// -----------------------------------------
// 0) URL から tenantId を取得
// -----------------------------------------
function loadTenantId() {
  const params = new URLSearchParams(location.search);
  const tid = params.get("tenantId");
  const input = document.getElementById("tenantId");
  if (tid) {
    input.value = tid;
  } else {
    input.value = "※ URL に tenantId がありません";
  }
}
loadTenantId();

// -----------------------------------------
// 1) Google Identity：アカウント選択
// -----------------------------------------
google.accounts.id.disableAutoSelect();

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const json = decodeURIComponent(
    atob(base64).split('').map(c => '%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join('')
  );
  return JSON.parse(json);
}

let selectedEmail = null;

function onCredentialResponse(response) {
  const data = parseJwt(response.credential);
  selectedEmail = data.email;

  document.getElementById("selectedAccount").style.display = "block";
  document.getElementById("selectedAccount").innerHTML =
    `<b>使用する Google アカウント：</b><br>${selectedEmail}`;

  document.getElementById("btnProvision").disabled = false;
}

// -----------------------------------------
// 2) Provision 呼び出し
// -----------------------------------------
async function runProvision() {
  const tid = document.getElementById("tenantId").value;

  if (!selectedEmail) {
    alert("STEP1：Google アカウントを選択してください。");
    return;
  }
  if (!tid || tid.startsWith("※")) {
    alert("STEP2：tenantId が正しく取得できません。URL を確認してください。");
    return;
  }

  const payload = {
    tenantId: tid,
    ownerEmail: selectedEmail,
  };

  const resultBox = document.getElementById("result");
  resultBox.textContent = "実行中...\n";

  const res = await fetch("https://lba-api.mahito-contact.workers.dev/provision", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  resultBox.textContent = text;
}

</script>

</body>
</html>
