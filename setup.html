<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LBA ç’°å¢ƒæ§‹ç¯‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: system-ui; padding: 20px; }
    .card { padding: 16px; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 20px; }
    button { padding: 10px 16px; font-size: 16px; }
  </style>
</head>
<body>
<h2>ğŸ“¦ LBA ç’°å¢ƒæ§‹ç¯‰</h2>

<div class="card">
  <h3>STEP 0ï¼šGoogle ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª</h3>
  <p>ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã® Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼š</p>
  <p id="currentAccount">ï¼ˆç¢ºèªä¸­...ï¼‰</p>

  <p style="color:#555;">
    â€»ã‚‚ã—åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ§‹ç¯‰ã—ãŸã„å ´åˆï¼š<br>
    â‘  ãƒ–ãƒ©ã‚¦ã‚¶å³ä¸Šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿ã‹ã‚‰ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ<br>
    â‘¡ ã“ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
  </p>
</div>

<div class="card">
  <h3>STEP 1ï¼šã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§é–‹å§‹</h3>
  <p>Google Drive ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</p>

  <button id="authorizeBtn">Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ‰¿èªã™ã‚‹</button>

  <pre id="authInfo" style="background:#eee; padding:10px; margin-top:15px;"></pre>
</div>

<div class="card">
  <h3>STEP 2ï¼šç’°å¢ƒæ§‹ç¯‰ã®å®Ÿè¡Œ</h3>
  <button id="provisionBtn" disabled>ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹</button>

  <pre id="result" style="background:#eee; padding:10px; margin-top:15px;"></pre>
</div>

<script>
/* ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ===== */
let googleAccessToken = null;
let ownerEmail = null;
const tenantId = new URL(location.href).searchParams.get("tenantId");

/* ===== STEP 0: ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º ===== */
function detectLoggedInAccount() {
  // Google ã® JS API ã§ "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ" ã‚’æ¨å®š
  google.accounts.id.initialize({
    client_id: "YOUR_GOOGLE_CLIENT_ID",
    callback: (response) => {
      const payload = JSON.parse(atob(response.credential.split('.')[1]));
      ownerEmail = payload.email;
      document.getElementById("currentAccount").textContent = ownerEmail;
    }
  });

  google.accounts.id.prompt(); // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ³ã‚’èª­ã¿å–ã‚‹
}

/* ===== STEP 1: OAuth æ‰¿èª ===== */
document.getElementById("authorizeBtn").onclick = async () => {
  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: "YOUR_GOOGLE_CLIENT_ID",
    scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/script.projects",
    callback: (token) => {
      googleAccessToken = token.access_token;
      document.getElementById("authInfo").textContent =
        "Google Drive / Apps Script ã®æ‰¿èªãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
      document.getElementById("provisionBtn").disabled = false;
    }
  });

  tokenClient.requestAccessToken();
};

/* ===== STEP 2: Worker ã« Provision ã‚’ä¾é ¼ ===== */
document.getElementById("provisionBtn").onclick = async () => {
  const payload = {
    tenantId,
    ownerEmail,
    accessToken: googleAccessToken
  };

  const res = await fetch("https://lba-api.mahito-contact.workers.dev/setup-start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const txt = await res.text();
  document.getElementById("result").textContent = txt;
};

/* èµ·å‹•æ™‚ */
detectLoggedInAccount();
</script>

</body>
</html>
