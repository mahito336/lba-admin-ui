<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LBA 環境構築</title>

<style>
  body {
    font-family: system-ui;
    background:#f5f5f5;
    padding:20px;
  }
  #app {
    max-width:480px;
    background:white;
    border-radius:12px;
    margin:0 auto;
    padding:24px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
  }
  button {
    padding:12px 20px;
    font-size:16px;
    border-radius:8px;
    border:none;
    background:#0066ff;
    color:white;
    margin-top:18px;
    width:100%;
    cursor:pointer;
  }
  #statusBox {
    background:#f0f0f0;
    padding:12px;
    margin-top:20px;
    border-radius:8px;
    font-size:14px;
    color:#555;
    word-break: break-all;
  }
</style>

<!-- Google Identity Services (GSI) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>

<div id="app">
  <h2>LBA — 環境構築</h2>

  <div id="tenantBox"></div>

  <p>この環境はあなたの Google アカウントと連携して構築されます。</p>

  <div id="g_id_signin"></div>

  <button id="provisionBtn" style="display:none;">
    このアカウントで構築する
  </button>

  <div id="statusBox"></div>
</div>

<script>
let jwtCredential = null;
let selectedEmail = null;

// tenantId を URL から抽出
const url = new URL(location.href);
const tenantId = url.searchParams.get("tenantId");

if (!tenantId) {
  document.getElementById("tenantBox").innerHTML =
    "<p style='color:red;'>tenantId が URL にありません。メールのリンクからアクセスしてください。</p>";
} else {
  document.getElementById("tenantBox").innerHTML =
    `<p><b>Tenant ID:</b> ${tenantId}</p>`;
}

// Google OAuth (GSI)
window.onload = function () {
  google.accounts.id.initialize({
    client_id: "990347544512-tu7i4t6cg65t4ihdtkbqo00gobtuvas0.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById("g_id_signin"),
    { theme: "outline", size: "large" }
  );
};

function handleCredentialResponse(response) {
  try {
    jwtCredential = response.credential;

    // JWT decode → email 取得
    const payload = JSON.parse(atob(jwtCredential.split('.')[1]));
    selectedEmail = payload.email;

    document.getElementById("statusBox").innerHTML =
      `<b>認証済み:</b> ${selectedEmail}`;

    document.getElementById("provisionBtn").style.display = "block";

  } catch (err) {
    document.getElementById("statusBox").innerHTML =
      "エラー: 認証情報を解析できませんでした。";
  }
}

// Worker 経由で GAS へプロビジョンを依頼
document.getElementById("provisionBtn").onclick = async function () {
  if (!tenantId || !selectedEmail) return;

  document.getElementById("statusBox").innerHTML =
    "環境を構築しています…（数秒〜10秒ほど）";

  try {
    const res = await fetch(
      "https://lba-api.mahito-contact.workers.dev/provision",
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          tenantId,
          ownerEmail: selectedEmail,
          credential: jwtCredential
        })
      }
    );

    const data = await res.json();
    console.log("Worker response:", data);

    if (!data.ok) {
      document.getElementById("statusBox").innerHTML =
        "Worker エラー：" + data.error;
      return;
    }

    const gas = JSON.parse(data.gasResponse);

    if (gas.ok) {
      document.getElementById("statusBox").innerHTML =
        `<b>環境構築が完了しました！</b><br><br>

         ▼ 講師ポータル<br>
         <a href="${gas.portalUrl}" target="_blank">${gas.portalUrl}</a><br><br>

         ▼ 生徒予約ページ<br>
         <a href="${gas.publicBookingUrl}" target="_blank">${gas.publicBookingUrl}</a>`;
    } else {
      document.getElementById("statusBox").innerHTML =
        "GAS エラー：" + gas.error;
    }

  } catch (err) {
    console.error(err);
    document.getElementById("statusBox").innerHTML =
      "通信エラー：" + err.message;
  }
};
</script>

</body>
</html>
