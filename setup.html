<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesson Booking Assistant - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</title>

<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #f6f7f9; }
  .wrap { max-width: 480px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 22px; margin: 0 0 16px; color: #333; text-align: center; }
  .box {
    background: #fff; padding: 20px; border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin-bottom: 20px;
  }
  button {
    width: 100%; padding: 14px; border: none; border-radius: 8px;
    font-size: 16px; font-weight: bold; background: #2563eb;
    color: white; cursor: pointer;
  }
  button:disabled { opacity: 0.6; }
  .loading { text-align: center; margin-top: 12px; font-size: 14px; color: #555; }
  .result-link a {
    display: block; margin: 8px 0; padding: 12px; border-radius: 8px;
    background: #eef2ff; text-decoration: none; color: #1e3a8a;
    text-align: center; font-size: 15px;
  }
</style>
</head>

<body>
<div class="wrap">

  <!-- STEP 0 -->
  <div class="box">
    <h1>ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h1>
    <p>
      ã“ã‚Œã‹ã‚‰ Lesson Booking Assistant ã®ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚<br><br>
      â€» ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯ <b>Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</b> ãŒå¿…è¦ã§ã™ã€‚<br>
      â€» Stripe æ±ºæ¸ˆæ™‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç•°ãªã‚‹ Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚<br>
      â€» ã“ã‚Œã‹ã‚‰ä½œæˆã•ã‚Œã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¯ã€ã„ã¾ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã® Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ã¥ãã¾ã™ã€‚
    </p>
  </div>

  <!-- STEP 1 -->
  <div class="box">
    <h3>â‘  Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèª</h3>
    <p>ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã® Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼š</p>
    <p id="googleEmail" style="font-weight:bold; font-size:16px">å–å¾—ä¸­...</p>

    <p style="margin-top:10px; font-size:14px; color:#666;">
      â€» åˆ¥ã® Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å ´åˆï¼š<br>
      <a href="https://accounts.google.com/Logout" target="_blank">Google ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a> â†’ ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
    </p>
  </div>

  <!-- STEP 2 -->
  <div class="box">
    <h3>â‘¡ ç’°å¢ƒæ§‹ç¯‰</h3>
    <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€è¬›å¸«ç”¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒä½œæˆã•ã‚Œã¾ã™ã€‚</p>
    <button id="btnSetup" onclick="startProvision()">ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹</button>
    <div id="loading" class="loading" style="display:none;">æ§‹ç¯‰ä¸­ã§ã™â€¦ æ•°ç§’ãŠå¾…ã¡ãã ã•ã„</div>
  </div>

  <!-- STEP 3 -->
  <div id="result" class="box" style="display:none;">
    <h3>â‘¢ å®Œäº†ã—ã¾ã—ãŸ ğŸ‰</h3>
    <p>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç®¡ç†ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</p>
    <div id="links" class="result-link"></div>
  </div>

</div>

<script>
const tenantId = new URL(location.href).searchParams.get("tenantId");

// Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå–å¾—
async function fetchGoogleAccount() {
  const url = "https://script.google.com/macros/s/___TEACHER_GAS_DEPLOY___/exec?mode=authCheck";
  const res = await fetch(url);
  const j = await res.json();
  document.getElementById("googleEmail").textContent = j.email || "(å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ)";
  return j.email;
}
fetchGoogleAccount();

// ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ³é–‹å§‹
async function startProvision() {
  const email = document.getElementById("googleEmail").textContent;
  if (!email || email.includes("å–å¾—ã§ãã¾ã›")) {
    alert("Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç¢ºèªã§ãã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  document.getElementById("btnSetup").disabled = true;
  document.getElementById("loading").style.display = "block";

  const payload = { tenantId, ownerEmail: email };

  const res = await fetch("https://lba-api.mahito-contact.workers.dev/provision", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const txt = await res.text();
  let j = {}; try { j = JSON.parse(txt); } catch (_) {}

  document.getElementById("loading").style.display = "none";

  if (!j.ok) { alert("ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—: " + j.error); return; }

  const gasRes = JSON.parse(j.gasResponse || "{}");
  if (!gasRes.ok) { alert("GAS å´ã‚¨ãƒ©ãƒ¼: " + gasRes.error); return; }

  // å®Œäº† UI
  document.getElementById("result").style.display = "block";
  document.getElementById("links").innerHTML = `
    <a href="${gasRes.portalUrl}" target="_blank">è¬›å¸«ãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ã</a>
    <a href="${gasRes.publicBookingUrl}" target="_blank">ç”Ÿå¾’å‘ã‘äºˆç´„ãƒšãƒ¼ã‚¸</a>
  `;
}
</script>

</body>
</html>
