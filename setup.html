<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>LBA ç’°å¢ƒæ§‹ç¯‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body { font-family: system-ui; padding: 20px; }
  .card { padding: 16px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; }
  button { padding: 10px 16px; font-size: 16px; cursor: pointer; }
  .disabled { opacity: 0.5; pointer-events: none; }
</style>
</head>

<body>
<h2>ğŸ“¦ LBA ç’°å¢ƒæ§‹ç¯‰</h2>

<p>
ãƒ¬ãƒƒã‚¹ãƒ³ç®¡ç†ç’°å¢ƒã‚’ä½œæˆã™ã‚‹ã«ã¯ã€<br>
<strong>Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯</strong> ãŒå¿…è¦ã§ã™ã€‚
</p>

<div class="card">
  <h3>STEP 1ï¼šGoogle ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ‰¿èª</h3>

  <p>
    ã“ã‚Œã‹ã‚‰ <strong>LBA ã®ç’°å¢ƒï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã‚’ä½œæˆã™ã‚‹ Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong> ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚  
    å¿…ãšã€Œè¬›å¸«ãŒæ™®æ®µåˆ©ç”¨ã—ã¦ã„ã‚‹ Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
  </p>

  <button id="authorizeBtn">Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹</button>

  <pre id="authInfo" style="background:#eee; padding:10px; margin-top:15px;"></pre>
</div>

<div class="card">
  <h3>STEP 2ï¼šç’°å¢ƒæ§‹ç¯‰ã‚’å®Ÿè¡Œ</h3>

  <p>
    ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚ãªãŸã® Google Drive ä¸Šã«<br>
    <strong>LBA ç”¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</strong> ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
  </p>

  <button id="provisionBtn" class="disabled">ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹</button>

  <pre id="result" style="background:#eee; padding:10px; margin-top:15px;"></pre>
</div>

<script>
/* ================================
   è¨­å®š
================================ */
const tenantId = new URL(location.href).searchParams.get("tenantId");
if (!tenantId) {
  document.body.innerHTML = "<h3>âŒ tenantId ãŒ URL ã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</h3>";
}

let googleAccessToken = null;
let ownerEmail = null;

/* ================================
   STEP1ï¼šOAuth èªè¨¼
================================ */
document.getElementById("authorizeBtn").onclick = () => {
  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: "YOUR_GOOGLE_CLIENT_ID",  // â† ã“ã“ã ã‘å·®ã—æ›¿ãˆã‚‹
    scope: "https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/script.projects",
    callback: (token) => {
      googleAccessToken = token.access_token;

      // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ email ã‚’å–å¾—
      fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
        headers: { Authorization: "Bearer " + googleAccessToken }
      })
      .then(res => res.json())
      .then(user => {
        ownerEmail = user.email;

        document.getElementById("authInfo").textContent =
          "âœ” æ‰¿èªå®Œäº†ï¼šã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç’°å¢ƒã‚’ä½œæˆã—ã¾ã™ â†’ " + ownerEmail;

        document.getElementById("provisionBtn").classList.remove("disabled");
      })
      .catch(err => {
        document.getElementById("authInfo").textContent = "âŒ Email å–å¾—ã‚¨ãƒ©ãƒ¼: " + err;
      });
    }
  });

  tokenClient.requestAccessToken();
};

/* ================================
   STEP2ï¼šWorker ã« Provision ã‚’ä¾é ¼
================================ */
document.getElementById("provisionBtn").onclick = async () => {
  const payload = {
    tenantId,
    ownerEmail,
    accessToken: googleAccessToken
  };

  const res = await fetch("https://lba-api.mahito-contact.workers.dev/setup-start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const txt = await res.text();
  document.getElementById("result").textContent = txt;
};

</script>

</body>
</html>
