<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LBA 環境構築</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .card {
      max-width: 480px;
      margin: 40px auto;
      background: white;
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.1);
    }
    .title {
      font-size: 20px;
      margin-bottom: 12px;
      font-weight: 600;
    }
    .msg {
      margin-top: 18px;
      padding: 12px;
      background: #eef;
      border-radius: 8px;
      word-break: break-all;
    }
    .btn {
      padding: 10px 18px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .btn-primary {
      background: #0066ff;
      color: white;
    }
    .hidden {
      display: none;
    }
  </style>
</head>

<body>

<div class="card">
  <div class="title">LBA 環境構築</div>

  <p>まず、環境を構築する Google アカウントでログインしてください。</p>

  <!-- ▼ Google Identity Services ログインボタン ▼ -->
  <div id="g_id_onload"
       data-client_id="745988638249-a91qhekn7c15b3oifaolqnc0fmrghi8p.apps.googleusercontent.com"
       data-context="signin"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-width="280">
  </div>
  <!-- ▲ Google Identity Services ログインボタン ▲ -->

  <div id="step2" class="hidden">
    <div class="msg" id="accountInfo"></div>

    <p style="margin-top:16px;">このアカウントで環境を作成しますか？</p>

    <button class="btn btn-primary" onclick="startProvision()">環境を作成する</button>

    <div class="msg hidden" id="provResult"></div>
  </div>
</div>

<script>
/* -------------------------------------------------------------
   JWT デコード（Google ID Token → email, name を取り出す）
------------------------------------------------------------- */
function parseJwt(token) {
  return JSON.parse(atob(token.split('.')[1]));
}

/* -------------------------------------------------------------
   Google ログイン完了 → email を取得
------------------------------------------------------------- */
let ACCOUNT_EMAIL = null;

function handleCredentialResponse(response) {
  const data = parseJwt(response.credential);

  ACCOUNT_EMAIL = data.email;
  const name = data.name;

  document.getElementById("accountInfo").textContent =
    `ログイン中のアカウント： ${name}（${ACCOUNT_EMAIL}）`;

  document.getElementById("step2").classList.remove("hidden");
}

/* -------------------------------------------------------------
   STEP 2：環境構築 API を呼び出す
   - tenantId は URL の ?tenantId=xxxx から取得
------------------------------------------------------------- */
async function startProvision() {
  const tenantId = new URL(location.href).searchParams.get("tenantId");

  if (!tenantId) {
    alert("tenantId が URL に含まれていません。");
    return;
  }
  if (!ACCOUNT_EMAIL) {
    alert("Google アカウントが取得できていません。");
    return;
  }

  const payload = {
    mode: "provision",
    tenantId,
    ownerEmail: ACCOUNT_EMAIL
  };

  const apiUrl = "https://lba-api.mahito-contact.workers.dev/provision";

  const res = await fetch(apiUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const txt = await res.text();
  const out = document.getElementById("provResult");

  out.classList.remove("hidden");
  out.textContent = txt;
}
</script>

</body>
</html>
